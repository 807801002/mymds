---
typora-root-url: ./
typora-copy-images-to: ./
---

# 1 交易型系统设计的一些原则

## 1.1 高并发原则

### 1.1.1 无状态

如果设计的应用是无状态的，那么应用比较容易进行水平扩展。实际生产环境可能是这样的：应用无状态，配置文件有状态。比如，不同机房需要读取不同的数据源，此时，就需要通过配置文件或配置中心指定。

### 1.1.2 拆分

系统维度：按照系统功能/业务拆分

功能维度：对一个系统进行功能再拆分

读写维度：读的量大于写，读服务可以考虑使用缓存提升性能；写的量太大时，需要考虑分库分表、数据异构拆分系统

### 1.1.3 服务化

随着调用方越来越多，应该考虑使用服务的自动注册和发现（如Dubbo和Zookeeper）。还要考虑服务分组/隔离，需要为不同的调用方提供不同的服务分组，隔离访问。后期随着调用量的增加还需要考虑服务的限流、黑白名单等。如超时时间、重试机制、服务路由（能动态切换不同的分组）、故障补偿等，这些都会影响到服务的质量。

进程内服务->单机远程服务->集群手动注册服务->自动注册和发现服务->服务的分组/隔离/路由->服务治理如限流/黑白名单。

### 1.1.4 消息队列

消息队列用老解耦一些不需要同步调用的服务或者订阅一些自己系统关心的变化。使用消息队列可以实现服务解耦（一对多消费）、异步处理、流量削峰/缓冲等。如果订阅者太多，那么订阅单个消息队列就会成为瓶颈，此时，需要考虑对消息队列进行多个镜像复制。

使用消息队列时，还要注意处理生产消息失败，以及消息重复接收时的场景。有些消息队列产品会提供生产重试功能，在达到指定重试次数还未生产成功时，会对外通知生产失败。此时，对于不能容忍生产失败的业务场景来说，一定要做好后续的数据处理工作，如持久化数据要同时增加日志、告警灯，对于消息重复问题，特别是一些分布式消息队列，出于对性能和开销的考虑，在一些场景下会发生消息重复接收，需要在业务层进行防重处理。

<font color="blue">1.大流量缓冲</font >

在电商高大促时，系统流量会高于正常流量的几倍甚至几十倍，此时就要进行一些特殊设计来保证系统平稳度过这段时期，解决手段很多，一般都是牺牲强一致性，而保证最终一致性

比如，扣减库存，可以考虑这样设计

![1541334523954](/1541334523954.png)

直接在Redis中扣减，然后记录下扣减日志，通过Worker同步到DB

还有，如交易订单系统，可以考虑这样设计。

![1541334634561](/1541334634561.png)

<font color="blue">2.数据校对</font>

在使用了消息异步的场景下，可能存在消息丢失，需要考虑进行数据校对和修正来保证数据的一致性和完整性。可以通过Worker定期去扫描原表，通过对业务数据进行校对，有问题的进行补偿，扫描周期根据实际场景进行定义。

### 1.1.5 数据异构

### 1.1.6 缓存银弹

### 1.1.7 并发化

## 1.2 高可用原则

## 1.3 业务设计原则 



# 2 负载均衡与反向代理

## 2.1 upstream配置

## 2.2 负载均衡算法

## 2.3 失败重试

## 2.4 健康检查

## 2.5 其他配置

## 2.6 长连接

## 2.7 HTTP反向代理示例

## 2.8 HTTP动态负载均衡

## 2.9 Nginx四层负载均衡

# 3 隔离术

# 15 队列术

## 15.1 应用场景

## 15.2 缓冲队列

## 15.3 任务队列

## 15.4 消息队列

## 15.5 请求队列

## 15.6 数据总线队列

## 15.7 混合队列

## 15.8 其他队列

